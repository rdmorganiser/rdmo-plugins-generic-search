# -------------------------------------------------------------------
# Generic Instrument Search – canonical config (schema v1)
# -------------------------------------------------------------------
[generic_search]
schema_version = 1

# UX & performance knobs
min_search_len = 3              # ignore queries shorter than this
max_workers    = 6              # thread-pool size (I/O bound)
max_total_hits = 50             # stop merging once total options reach this
sort_key       = "text"         # "text"|"id"|"" (keep as-completed order)

# Defaults for built-in "recipe" providers (merged into each provider)
[generic_search.defaults.recipe]
max_hits = 10                   # cap items mapped to options per provider
lang     = "en"                 # default language for SPARQL etc.

# Optional shared auth blocks (reference via providers[*].auth_ref)
# [generic_search.auth.my_token]
# type   = "header"             # "basic" | "header" | "query"
# header = "Authorization"
# value  = "Bearer ${INSTRUMENT_API_TOKEN}"   # env expansion supported by loader


# ===================================================================
# Handlers – map a provider’s detail document to RDMO attributes
# ===================================================================
# Use either a single inline config per handler family, or an array of configs:
#   [generic_search.handlers.<name>]               # single config
#   [[generic_search.handlers.<name>.config]]      # multiple configs
#
# Each config requires:
#   - name (matched against "id_prefix" part of external_id)
#   - catalog_uri (the target catalog)
#   - auto_complete_field_uri (the question used for the search widget)
#   - attribute_mapping (JMESPath -> attribute URI)

# ---- O2Aregistry handler and mapping --- #
[generic_search.handlers.o2areg]  # handler for o2a registry
name = "o2areg"
catalog_uri = "http://example.com/terms/questions/generic-instrument-search-example-catalog"
auto_complete_field_uri = "https://rdmorganiser.github.io/terms/domain/project/dataset/title"

[generic_search.handlers.o2areg.attribute_mapping]
"longName"          = "https://rdmorganiser.github.io/terms/domain/project/dataset/description"
"shortName"         = "https://rdmorganiser.github.io/terms/domain/project/dataset/documentation"
"serialNumber"      = "https://rdmorganiser.github.io/terms/domain/project/dataset/id"
"parameters[].name" = "https://rdmorganiser.github.io/terms/domain/project/dataset/usage_description"
"parameters[].unit" = "https://rdmorganiser.github.io/terms/domain/project/dataset/usage_frequency"

# ---- Wikidata handler and mapping --- #
[generic_search.handlers.wdata]  # handler for wikidata
catalog_uri = "http://example.com/terms/questions/generic-instrument-search-example-catalog"
auto_complete_field_uri = "https://rdmorganiser.github.io/terms/domain/project/dataset/title"

[generic_search.handlers.wdata.attribute_mapping]
# scalar fields with language fallbacks
"entities.*[].labels.{lang}.value || entities.*[].labels.en.value || entities.*[].labels.de.value" = "https://rdmorganiser.github.io/terms/domain/project/dataset/description"
"entities.*[].descriptions.{lang}.value || entities.*[].descriptions.en.value || entities.*[].descriptions.de.value" = "https://rdmorganiser.github.io/terms/domain/project/dataset/usage_description"
# the wikidata id
"entities.*[].id" = "https://rdmorganiser.github.io/terms/domain/project/dataset/id"

# list field with language fallbacks
"entities.*[].aliases.{lang}[].value || entities.*[].aliases.en[].value || entities.*[].aliases.de[].value" = "http://example.org/terms/domain/instrument/type/aliases"

# website (no language)
"entities.*[].claims.P856[0].mainsnak.datavalue.value" = "https://rdmorganiser.github.io/terms/domain/project/dataset/documentation"

# ---- NOMAD handler and mapping --- #
[generic_search.handlers.nomad]
name = "nomad"
catalog_uri = "http://example.com/terms/questions/generic-instrument-search-example-catalog"
auto_complete_field_uri = "https://rdmorganiser.github.io/terms/domain/project/dataset/title"

[generic_search.handlers.nomad.attribute_mapping]
# Long / primary name – take the instrument name, fall back to ELN name or entry_name
"results.eln.instruments[0] || results.eln.names[0] || entry_name" = "https://rdmorganiser.github.io/terms/domain/project/dataset/description"

# Description / documentation – NOMAD’s ELN description (HTML string is fine, RDMO will store text)
"results.eln.descriptions[0]" = "https://rdmorganiser.github.io/terms/domain/project/dataset/documentation"

# Identifier / serial – use lab_id if present, otherwise fall back to NOMAD entry_id
"results.eln.lab_ids[0] || entry_id" = "https://rdmorganiser.github.io/terms/domain/project/dataset/id"

# Aliases – all ELN names as aliases (similar idea to Wikidata aliases)
"results.eln.names[]" = "http://example.org/terms/domain/instrument/type/aliases"

# ---- PIDINST handler and mapping --- #
[generic_search.handlers.pidinst]
name = "pidinst"
catalog_uri = "http://example.com/terms/questions/generic-instrument-search-example-catalog"
auto_complete_field_uri = "https://rdmorganiser.github.io/terms/domain/project/dataset/title"

[generic_search.handlers.pidinst.attribute_mapping]
# Main name / type-like label for the instrument
"datacite_attribute.descriptions[*].description ||  b2inst_attributes.Description" = "https://rdmorganiser.github.io/terms/domain/project/dataset/description"
#"datacite_attribute.titles[*].title"
# Free-text documentation / abstract
"landing_page" = "https://rdmorganiser.github.io/terms/domain/project/dataset/documentation"

# Identifier (PID/DOI)
"pid"                             = "https://rdmorganiser.github.io/terms/domain/project/dataset/id"

# Future PIDINST-specific parameter fields (extend once you have them):
"b2inst_attributes.MeasuredVariable[]"  = "https://rdmorganiser.github.io/terms/domain/project/dataset/usage_description"
# "pidinst_attributes.parameters[].unit"  = "https://rdmorganiser.github.io/terms/domain/project/dataset/usage_frequency"

# ---- B2INST handler and mapping --- #
[generic_search.handlers.b2inst]
name = "b2inst"
catalog_uri = "http://example.com/terms/questions/generic-instrument-search-example-catalog"
auto_complete_field_uri = "https://rdmorganiser.github.io/terms/domain/project/dataset/title"

[generic_search.handlers.b2inst.attribute_mapping]
"b2inst_attributes.Description || datacite_attributes.descriptions[*].description || name" = "https://rdmorganiser.github.io/terms/domain/project/dataset/description"
"landing_page" = "https://rdmorganiser.github.io/terms/domain/project/dataset/documentation"
"pid" = "https://rdmorganiser.github.io/terms/domain/project/dataset/id"
"b2inst_attributes.Model.modelName" = "https://rdmorganiser.github.io/terms/domain/project/dataset/usage_description"

# ----- Example handler with array fields (shows how [] in mapping becomes list handling) -------#
[generic_search.handlers.example]
name = "example"
catalog_uri = "http://example.com/terms/questions/test-instrument-search"
auto_complete_field_uri = "http://example.com/terms/domain/search/instrument/example"

[generic_search.handlers.example.attribute_mapping]
"longName"      = "http://example.com/terms/domain/search/instrument/example/long-name"
"shortName"     = "http://example.com/terms/domain/search/instrument/example/short-name"
"serialNumber"  = "http://example.com/terms/domain/search/instrument/example/serial"
"aliases[]"     = "http://example.com/terms/domain/search/instrument/example/aliases"   # -> list
"keywords[]"    = "http://example.com/terms/domain/search/instrument/example/keywords"  # -> list


# ===================================================================
# Providers – search + detail + transforms (engine="recipe")
# ===================================================================
# Each provider must define:
#   - id_prefix       short key that prefixes external_id (e.g. "o2areg:1234")
#   - engine          currently only "recipe" is supported
#   - base_url/text_prefix/max_hits (optional overrides)
#   - [search]        mode + mapping from raw items to {id,text}
#   - [detail]        one or more HTTP steps; optional transforms
#   - [handler]       optional link to a handler by name (docs only; resolution is done at signal time)

# --- O2A Registry (server search + multi-step detail + transforms) -----------
[[generic_search.providers]]
id_prefix   = "o2areg"
engine      = "recipe"
text_prefix = "O2A REGISTRY:"
base_url    = "https://registry.o2a-data.de"
# auth_ref  = "my_token"        # uncomment if using the shared auth block

[generic_search.providers.search]
mode           = "server"
url            = "{base_url}/index/rest/search/sensor-v2?q=(title:({query}*)^2 OR id:(/{query}/)^20 OR ({query}*)^0) AND (states.itemState:(public devicestore)^0)&hits=10"
items_path     = "records"
id_path        = "uniqueId"
label_path     = "title"
label_template = "{prefix} {label}"

[generic_search.providers.detail]
steps = [
  { url = "{base_url}/rest/v2/items/{id}" },
  { url = "{base_url}/rest/v2/items/{id}/contacts",   assign = "_contacts" },
  { url = "{base_url}/rest/v2/items/{id}/parameters", assign = "_parameters" },
  { url = "{base_url}/rest/v2/units",                 assign = "_units" }
]
transforms = [
  { dotted = "rdmo_generic_instrument_search.providers.transforms.o2aregistry:add_contacts_from_o2a" },
  { dotted = "rdmo_generic_instrument_search.providers.transforms.o2aregistry:add_parameters_with_units_from_o2a" }
]

[generic_search.providers.handler]
ref = "o2areg"                  # references the handler defined above


# --- GFZ GIPP (client-side filter over large JSON index + 1-step detail) ----
[[generic_search.providers]]
id_prefix   = "gfzgipp"
engine      = "recipe"
text_prefix = "GIPP:"
base_url    = "https://gipp.gfz-potsdam.de/instruments"

[generic_search.providers.search]
mode             = "client_filter"
url              = "{base_url}/index.json?limit=10000&program=MOSES"
items_path       = "@"
id_path          = "Instrument.id"
label_path       = "Instrument.code"
label_template   = "{prefix} {code}"
filter_any_paths = ["Instrument.*"]   # scan these paths for a substring match

[generic_search.providers.detail]
steps = [
  { url = "{base_url}/rest/{id}.json" }
]

# --- Wikidata (Action API search + flatten detail)
[[generic_search.providers]]
id_prefix   = "wdata"
engine      = "recipe"
text_prefix = "WD:"
base_url    = "https://www.wikidata.org"
max_hits    = 30

[generic_search.providers.search]
mode     = "wikidata_action"   # ← use Action API instead of SPARQL
root_qid = "Q2041172"          # measuring instrument
lang     = "en"                # optional; defaults to generic_search.defaults.recipe.lang

# map items (we build labels in code; id is QID)
# no items_path/id_path/label_path needed for wikidata_action

[generic_search.providers.detail]
steps = [
  { url = "{base_url}/w/api.php?action=wbgetentities&ids={id}&languages=en|de&format=json" }
]
transforms = [
  { dotted = "rdmo_generic_instrument_search.providers.transforms:wikidata_flatten" }
]

# --- Wikidata (SPARQL entity search + flatten detail) -----------------------
[[generic_search.providers]]
id_prefix   = "wdata_sparql"
engine      = "recipe"
text_prefix = "WD:"
base_url    = "https://www.wikidata.org"
max_hits    = 30

[generic_search.providers.search]
mode     = "sparql"
endpoint = "https://query.wikidata.org/sparql"
root_qid = "Q2041172"     # measuring instrument
# lang   = "en"           # override defaults.recipe.lang if needed
query = """
SELECT ?item ?itemLabel ?itemDescription WHERE {
  SERVICE wikibase:mwapi {
    bd:serviceParam wikibase:endpoint "www.wikidata.org" .
    bd:serviceParam wikibase:api "EntitySearch" .
    bd:serviceParam mwapi:search "{query}" .
    bd:serviceParam mwapi:language "{lang}" .
    bd:serviceParam mwapi:limit "30" .
    ?item wikibase:apiOutputItem mwapi:item .
  }
  ?item wdt:P279* wd:{root_qid} .
  FILTER NOT EXISTS { ?item wdt:P361 ?whole }
  SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],{lang},en,de". }
}
"""
items_path     = "results.bindings"
id_path        = "item.value"          # full IRI -> provider normalizes to Qxxxx
label_path     = "itemLabel.value"
label_template = "{prefix} {label}"

[generic_search.providers.detail]
steps = [
  { url = "{base_url}/w/api.php?action=wbgetentities&ids={id}&languages=en|de&format=json" }
]
transforms = [
  { dotted = "rdmo_generic_instrument_search.providers.transforms:wikidata_flatten" }
]

#--- NOMAD API ---#
[[generic_search.providers]]
id_prefix   = "nomad"
engine      = "recipe"
text_prefix = "NOMAD:"
base_url    = "https://nomad-lab.eu/prod/v1/api/v1"

[generic_search.providers.search]
mode           = "server"
url            = '{base_url}/entries?owner=public&json_query={{"results.eln.sections":["Instrument"],"results.eln.instruments:any":["{query}"]}}'
items_path     = "data"
id_path        = "entry_id"
label_path     = "results.eln.instruments[0] || results.eln.names[0] || entry_name"
label_template = "{prefix} {label}"

[generic_search.providers.detail]
  steps = [
    { url = "{base_url}/entries/{id}" }
  ]

#--- PIDINST local static ---#
[[generic_search.providers]]
id_prefix   = "pidinst"
engine      = "recipe"
text_prefix = "PIDINST:"
max_hits    = 25

[generic_search.providers.search]
mode = "client_filter"
# local static file URL
url = "static://instrument_search/pidinst_all.json"
# JSON is a list of instruments at top level
items_path = "@"
id_path = "pid"

# label: prefer 'name', fall back to DataCite title or pid
label_path = "name || pid || datacite_attributes.titles[0].title"
label_template = "{prefix} {label}"

# Fields for full-text filtering
filter_any_paths = [
  "pid",
  "name",
  "owner",
  "manufacturer",
  "instrument_type",
  "model",
  "measured_variable",
  "datacite_attributes.titles[].title"
]

[generic_search.providers.detail]
steps = [
  { url = "{base_url}" }
]
transforms = [
  { dotted = "rdmo_generic_instrument_search.providers.transforms.pidinst:normalize_pidinst_record" }
]

[generic_search.providers.handler]
ref = "pidinst"

#--- B2INST API ---#
[[generic_search.providers]]
id_prefix   = "b2inst"
engine      = "recipe"
text_prefix = "B2INST:"
base_url    = "https://b2inst.gwdg.de/records"

[generic_search.providers.search]
mode           = "server"
url            = "{base_url}/?q={query}&sort=mostrecent&page=1&size=10"
items_path     = "hits.hits"
id_path        = "id"
label_path     = "metadata.title || metadata.titles[0].title || metadata.b2inst_attributes.Name"
label_template = "{prefix} {label}"

[generic_search.providers.detail]
steps = [
  { url = "{base_url}/{id}" }
]
transforms = [
  { dotted = "rdmo_generic_instrument_search.providers.transforms.b2inst:normalize_b2inst_record" }
]

[generic_search.providers.handler]
ref = "b2inst"


# --- Example API (template) --------------------------------------------------
[[generic_search.providers]]
id_prefix   = "example"
engine      = "recipe"
text_prefix = "Example:"
base_url    = "https://example.com/api/v1/instruments"

[generic_search.providers.search]
mode           = "server"
url            = "{base_url}/search?q={query}"
items_path     = "data"
id_path        = "id"
label_path     = "attributes.long_name || attributes.short_name"
label_template = "{prefix} {label}"

[generic_search.providers.detail]
steps = [
  { url = "{base_url}/items/{id}" },
  { url = "{base_url}/items/{id}/contacts",  assign = "_contacts" }
]
# transforms = [ { dotted = "your.module:your_transform", kwargs = { } } ]

[generic_search.providers.handler]
ref = "example"
